{% extends 'tasks/base.html' %}

{% block content %}
<!-- Control Panel -->
<div class="glass-effect rounded-3xl p-6 mb-8 border border-white border-opacity-20">
    <div class="flex items-center mb-4">
        <span class="text-2xl mr-3">ğŸ›ï¸</span>
        <h2 class="text-xl font-semibold text-gray-800">Control Panel</h2>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-600">ğŸ¯ Priority</label>
            <select id="priority-filter" class="w-full px-4 py-3 bg-white bg-opacity-50 border-0 rounded-xl focus:ring-2 focus:ring-purple-400 transition-all">
                <option value="">All Levels</option>
                <option value="Low">ğŸŸ¢ Low</option>
                <option value="Medium">ğŸŸ¡ Medium</option>
                <option value="High">ğŸ”´ High</option>
            </select>
        </div>
        
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-600">ğŸ“Š Status</label>
            <select id="status-filter" class="w-full px-4 py-3 bg-white bg-opacity-50 border-0 rounded-xl focus:ring-2 focus:ring-purple-400 transition-all">
                <option value="">All Stages</option>
                <option value="To-Do">ğŸ“ To-Do</option>
                <option value="In-Progress">âš¡ In-Progress</option>
                <option value="Completed">âœ… Completed</option>
            </select>
        </div>
        
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-600">ğŸ”„ Sort</label>
            <select id="sort-filter" class="w-full px-4 py-3 bg-white bg-opacity-50 border-0 rounded-xl focus:ring-2 focus:ring-purple-400 transition-all">
                <option value="newest">ğŸ†• Newest</option>
                <option value="oldest">ğŸ“… Oldest</option>
                <option value="due_date">â° Due Date</option>
            </select>
        </div>
        
        <div class="flex items-end">
            <button onclick="applyFilters()" class="w-full gradient-bg text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-300 font-medium">
                ğŸ” Apply Filters
            </button>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-white border-opacity-20">
        <button onclick="loadSampleData()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-xl transition-all">
            ğŸ² Load Sample Data
        </button>
        <button onclick="clearAllData()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl transition-all">
            ğŸ—‘ï¸ Clear All Data
        </button>
    </div>
</div>

<!-- Task Workflow Board -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Backlog Zone -->
    <div class="relative">
        <div class="absolute -top-2 -left-2 w-full h-full bg-gradient-to-br from-red-200 to-pink-200 rounded-3xl opacity-30"></div>
        <div class="relative bg-white rounded-3xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-red-500 to-pink-500 p-6">
                <div class="flex items-center justify-between text-white">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <span class="text-lg">ğŸ“</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">Backlog</h3>
                            <p class="text-red-100 text-sm">Ideas & Planning</p>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                        <span class="font-bold" id="todo-count">0</span>
                    </div>
                </div>
            </div>
            <div class="p-6 min-h-96 space-y-4" id="todo-column" data-status="To-Do">
                <div class="text-center py-12" id="todo-empty">
                    <div class="text-6xl mb-4">ğŸ¯</div>
                    <p class="text-gray-400 font-medium">Ready for new ideas!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Zone -->
    <div class="relative">
        <div class="absolute -top-2 -left-2 w-full h-full bg-gradient-to-br from-yellow-200 to-orange-200 rounded-3xl opacity-30"></div>
        <div class="relative bg-white rounded-3xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-6">
                <div class="flex items-center justify-between text-white">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center pulse-ring">
                            <span class="text-lg">âš¡</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">In Motion</h3>
                            <p class="text-yellow-100 text-sm">Active Development</p>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                        <span class="font-bold" id="inprogress-count">0</span>
                    </div>
                </div>
            </div>
            <div class="p-6 min-h-96 space-y-4" id="inprogress-column" data-status="In-Progress">
                <div class="text-center py-12" id="inprogress-empty">
                    <div class="text-6xl mb-4">ğŸš€</div>
                    <p class="text-gray-400 font-medium">Ready to work!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Victory Zone -->
    <div class="relative">
        <div class="absolute -top-2 -left-2 w-full h-full bg-gradient-to-br from-green-200 to-emerald-200 rounded-3xl opacity-30"></div>
        <div class="relative bg-white rounded-3xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-6">
                <div class="flex items-center justify-between text-white">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center floating">
                            <span class="text-lg">ğŸ†</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">Victory</h3>
                            <p class="text-green-100 text-sm">Mission Complete</p>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                        <span class="font-bold" id="completed-count">0</span>
                    </div>
                </div>
            </div>
            <div class="p-6 min-h-96 space-y-4" id="completed-column" data-status="Completed">
                <div class="text-center py-12" id="completed-empty">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <p class="text-gray-400 font-medium">Achievements await!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Board functionality
function renderTasks() {
    const filters = {
        priority: document.getElementById('priority-filter').value,
        status: document.getElementById('status-filter').value,
        sort: document.getElementById('sort-filter').value
    };
    
    const tasks = taskManager.getTasks(filters);
    
    // Clear all columns
    ['todo', 'inprogress', 'completed'].forEach(status => {
        const column = document.getElementById(`${status}-column`);
        const emptyState = document.getElementById(`${status}-empty`);
        
        // Remove all task cards
        const taskCards = column.querySelectorAll('.task-card');
        taskCards.forEach(card => card.remove());
        
        // Show/hide empty state
        const statusTasks = tasks.filter(task => {
            if (status === 'todo') return task.status === 'To-Do';
            if (status === 'inprogress') return task.status === 'In-Progress';
            if (status === 'completed') return task.status === 'Completed';
        });
        
        if (statusTasks.length === 0) {
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
            statusTasks.forEach(task => {
                const taskCard = createTaskCard(task);
                column.insertBefore(taskCard, emptyState);
            });
        }
    });
    
    updateTaskCounts();
}

function createTaskCard(task) {
    const card = document.createElement('div');
    card.className = `task-card bg-white rounded-2xl p-5 cursor-move card-hover shadow-lg border-l-4 ${getPriorityBorderClass(task.priority)}`;
    card.dataset.taskId = task.id;
    
    const isDuplicate = taskManager.isDuplicate(task.title, task.status, task.id);
    
    card.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div class="flex items-center space-x-2">
                ${getPriorityIcon(task.priority)}
                <span class="${getPriorityClass(task.priority)} px-3 py-1 rounded-full text-xs font-semibold">
                    ${task.priority.toUpperCase()}
                </span>
            </div>
            ${isDuplicate ? '<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-lg text-xs font-medium">ğŸ”„ Duplicate</span>' : ''}
        </div>
        
        <h4 class="font-bold text-gray-800 mb-3 text-lg leading-tight">
            ${task.title}
        </h4>
        
        ${task.description ? `<p class="text-gray-600 text-sm mb-4 leading-relaxed">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</p>` : ''}
        
        <div class="space-y-2 mb-4">
            ${task.due_date ? `
                <div class="flex items-center text-sm text-gray-500">
                    <span class="mr-2">â°</span>
                    <span class="font-medium">${formatDate(task.due_date)}</span>
                </div>
            ` : ''}
            
            <div class="flex items-center text-xs text-gray-400">
                <span class="mr-2">ğŸ“…</span>
                <span>Created ${formatDate(task.created_at)}</span>
            </div>
        </div>
        
        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
            <div class="flex space-x-3">
                <button onclick="editTask(${task.id})" class="flex items-center text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors">
                    <span class="mr-1">âœï¸</span>Edit
                </button>
                <button onclick="deleteTask(${task.id})" class="flex items-center text-red-500 hover:text-red-700 text-sm font-medium transition-colors">
                    <span class="mr-1">ğŸ—‘ï¸</span>Delete
                </button>
            </div>
            <div class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">
                #${task.id}
            </div>
        </div>
    `;
    
    return card;
}

function getPriorityIcon(priority) {
    switch(priority) {
        case 'High': return '<span class="text-lg">ğŸ”¥</span>';
        case 'Medium': return '<span class="text-lg">âš¡</span>';
        case 'Low': return '<span class="text-lg">ğŸŒ±</span>';
        default: return '<span class="text-lg">âš¡</span>';
    }
}

function getPriorityClass(priority) {
    switch(priority) {
        case 'High': return 'bg-red-100 text-red-700';
        case 'Medium': return 'bg-yellow-100 text-yellow-700';
        case 'Low': return 'bg-green-100 text-green-700';
        default: return 'bg-yellow-100 text-yellow-700';
    }
}

function getPriorityBorderClass(priority) {
    switch(priority) {
        case 'High': return 'border-red-400';
        case 'Medium': return 'border-yellow-400';
        case 'Low': return 'border-green-400';
        default: return 'border-yellow-400';
    }
}

function updateTaskCounts() {
    const tasks = taskManager.getTasks();
    const todoCount = tasks.filter(t => t.status === 'To-Do').length;
    const inProgressCount = tasks.filter(t => t.status === 'In-Progress').length;
    const completedCount = tasks.filter(t => t.status === 'Completed').length;
    
    // Update count badges (you'll need to add these to the HTML)
    const todoBadge = document.querySelector('#todo-count');
    const inProgressBadge = document.querySelector('#inprogress-count');
    const completedBadge = document.querySelector('#completed-count');
    
    if (todoBadge) todoBadge.textContent = todoCount;
    if (inProgressBadge) inProgressBadge.textContent = inProgressCount;
    if (completedBadge) completedBadge.textContent = completedCount;
}

function applyFilters() {
    renderTasks();
}

function loadSampleData() {
    taskManager.loadSampleData();
    renderTasks();
    showMessage('Sample data loaded successfully!');
}

function clearAllData() {
    if (confirm('Are you sure you want to delete all tasks? This cannot be undone.')) {
        localStorage.removeItem('taskflow_tasks');
        taskManager.tasks = [];
        renderTasks();
        showMessage('All data cleared successfully!');
    }
}

function editTask(id) {
    // Create a simple modal for editing
    const task = taskManager.getTask(id);
    if (!task) return;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-3xl p-8 max-w-2xl w-full mx-4">
            <h3 class="text-2xl font-bold mb-6">Edit Task</h3>
            <form id="edit-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Title</label>
                        <input type="text" id="edit-title" value="${task.title}" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea id="edit-description" rows="3" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400">${task.description}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Priority</label>
                            <select id="edit-priority" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400">
                                <option value="Low" ${task.priority === 'Low' ? 'selected' : ''}>Low</option>
                                <option value="Medium" ${task.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="High" ${task.priority === 'High' ? 'selected' : ''}>High</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Status</label>
                            <select id="edit-status" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400">
                                <option value="To-Do" ${task.status === 'To-Do' ? 'selected' : ''}>To-Do</option>
                                <option value="In-Progress" ${task.status === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                                <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Due Date</label>
                        <input type="datetime-local" id="edit-due-date" value="${task.due_date ? task.due_date.substring(0, 16) : ''}" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-6 py-3 rounded-xl">Cancel</button>
                    <button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-xl">Update Task</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const updates = {
            title: document.getElementById('edit-title').value,
            description: document.getElementById('edit-description').value,
            priority: document.getElementById('edit-priority').value,
            status: document.getElementById('edit-status').value,
            due_date: document.getElementById('edit-due-date').value || null
        };
        
        taskManager.updateTask(id, updates);
        renderTasks();
        modal.remove();
        showMessage('Task updated successfully!');
    });
}

function deleteTask(id) {
    if (confirm('Are you sure you want to delete this task?')) {
        taskManager.deleteTask(id);
        renderTasks();
        showMessage('Task deleted successfully!');
    }
}

// Initialize drag and drop
document.addEventListener('DOMContentLoaded', function() {
    const columns = ['todo-column', 'inprogress-column', 'completed-column'];
    
    columns.forEach(columnId => {
        const column = document.getElementById(columnId);
        if (column) {
            new Sortable(column, {
                group: 'tasks',
                animation: 150,
                ghostClass: 'opacity-50',
                filter: '.text-center',
                onEnd: function(evt) {
                    const taskId = parseInt(evt.item.dataset.taskId);
                    const newStatus = evt.to.dataset.status;
                    
                    taskManager.updateTask(taskId, { status: newStatus });
                    renderTasks();
                    showMessage(`Task moved to ${newStatus}!`);
                }
            });
        }
    });
    
    // Initial render
    renderTasks();
    
    // Add event listeners for filters
    ['priority-filter', 'status-filter', 'sort-filter'].forEach(id => {
        document.getElementById(id).addEventListener('change', renderTasks);
    });
});
</script>
{% endblock %}